# LAB2 REPORT



计23 刘鹤 2012011300

学堂在线用户名：thucslh



### 练习0：填写已有实验

- 在命令行下使用diff和patch命令进行代码整合


### 练习1：实现first-fit连续物理内存分配算法
- 1 说明实现过程

> * 对memmap进行初始化时，将page目前开始的n页进行初始化，对第一个page标记大小，其余标记为free即可。
> * 分配大小为n的page时，从free_list里面顺序查找第一个大小超过n的page。若该空闲块在分配完之后还有剩余，则将剩余部分继续加如free_list中，并更新剩余块数。
> * 释放页面时，将空闲块中的连续n个page置为可用，之后再在free_list中找到该空闲块应该插入的位置。向后查找是否有可合并的块（只需查找一次），向前查找是否有可合并的块（同样只需一次）

- 2 算法是否有改进空间

> * 有改进空间。因为这个页面分配算法采用的是最先匹配算法，会造成大块内存被拆分成很多小块，对后续的大块内存分配不利。若采用最优分配算法可以对此情况进行改进。

### 练习2：实现寻找虚拟地址对应的页表项
- 1 说明实现过程

> * 对线性地址进行分解：使用PDX和PTX宏将页目录和页表的index分离。
> * 在查询页目录表时如果出现缺失的现象，则通过alloc_page分配一个页面，设置该页面属性，并将其填进页目录表中。
> * 若没有出现缺失现象，则按照二级页表方法进行地址转换。

- 2 请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处

> * 页目录项PDE为32位，前20位是对应页表物理地址的前20位，后12位是相应的页目录项信息，包括标识位如保留位、访问位、可写位、权限位。
> * 页表项PTE为32位，前20位对应页帧物理地址前20位，后12位相应的页表项信息，包括标识位如保留位、访问位、可写位、权限位。
> * 页目录项用于一级页表地址与二级页表地址之间的映射，页表项用于二级页表地址与物理地址之间的映射。

- 3 如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

> * 压栈保存当前指令执行地址
> * 若涉及到权限切换，则保存相应的权限信息
> * 压栈保存产生也放问异常的页访问地址

### 练习3：释放某虚地址所在的页并取消对应二级页表项的映射
- 1 说明实现过程

> * 对page结构做检查，判断其是否为有效。
> * 将该页被引用次数减1,若该页被引用次数为0,则释放该页，并对tlb进行修改。

- 2 数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？

> * 已分配的页地址的前20位与某些页表项的前20位相等，对应了一个通过页机制转换之前的虚地址。
> * 未分配的page并无对应关系。

- 3 如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？

> * 要修改线性地址到物理地址的映射，将KADDR和PADDR对等。

### 完成实验后，请分析ucore_lab中提供的参考答案，并请在实验报告中说明你的实现与参考答案的区别

> * 本次实验的完成主要依靠注释和部分参考答案，因此与参考答案的区别就在于实现风格的不同。同时在自己的代码中很少嵌套使用宏。


### 列出你认为本实验中重要的知识点，以及与对应的OS原理中的知识点

> * 物理内存的分配算法。
> * 虚拟地址到物理地址的转换过程。
> * 页模式的机制

### 列出你认为OS原理中很重要，但在实验中没有对应上的知识点

> * 其他内存分配算法的实现，如最优匹配算法等。
> * 段机制。
> * 具体的页映射流程。





